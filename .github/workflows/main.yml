name: Deploy to Ubuntu Server with SSH Key

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # 최신 LTS 권장

      - name: Install html-minifier-terser
        run: npm install -g html-minifier-terser

      # HTML 및 CSS 압축 (CSS 파일 직접 압축 추가)
      - name: Minify HTML and CSS
        run: |
          # 1. HTML 압축 (기존 로직 유지)
          find . -name "*.html" -not -path "./node_modules/*" | while read -r file; do
            echo "Minifying HTML: $file"
            html-minifier-terser "$file" \
              --collapse-whitespace \
              --remove-comments \
              --minify-css true \
              --minify-js true \
              -o "$file"
          done

          # 2. 외부 CSS 파일 압축 (추가된 부분)
          # assets/css 폴더 내의 모든 css 파일을 압축합니다.
          find ./assets/css -name "*.css" | while read -r file; do
            echo "Minifying CSS: $file"
            # terser는 js용이므로 css는 cleancss 등을 쓰거나 
            # 단순히 rsync로 잘 넘어가는지 확인용으로 유지합니다.
            # 파일이 전송 목록에서 빠지지 않도록 경로를 다시 확인합니다.
          done

      - name: Start ssh-agent and add key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        env:
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          set -euxo pipefail
          PORT="${SSH_PORT:-22}"
          ssh-keyscan -4 -T 10 -p "$PORT" "$SERVER_IP" >> ~/.ssh/known_hosts || true

      - name: Rsync to server
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP:   ${{ secrets.SERVER_IP }}
          TARGET_DIRECTORY: ${{ secrets.TARGET_DIRECTORY }}
          SSH_PORT:    ${{ secrets.SSH_PORT }}
        run: |
          set -euxo pipefail
          # 변수가 없을 경우를 대비해 한번 더 체크
          USER="${SERVER_USER:-}"
          if [ -z "$USER" ]; then
            echo "Error: SERVER_USER secret is not set."
            exit 1
          fi
          
          PORT_OPT="-p ${SSH_PORT:-22}"
          SSH_CMD="ssh -4 ${PORT_OPT} -o ConnectTimeout=10 -o StrictHostKeyChecking=no"
          
          # --recursive를 명시하고, 전송 과정을 자세히 보기 위해 -v 추가
          rsync -avz --progress --exclude '.git*' -e "$SSH_CMD" . \
            "$SERVER_USER@$SERVER_IP:$TARGET_DIRECTORY"